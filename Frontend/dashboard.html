<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rainfall Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: #333;
        font-size: 28px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .admin-badge {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .user-badge {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .logout-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s ease;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
      }

      .dashboard-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .tabs {
        display: flex;
        margin-bottom: 30px;
        border-bottom: 2px solid #e1e1e1;
      }

      .tab {
        padding: 15px 25px;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab:hover {
        color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .search-section {
        background: #f8f9ff;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid #e1e8ff;
      }

      .search-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
      }

      .form-group input,
      .form-group select {
        padding: 12px 15px;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        border-color: #667eea;
      }

      .search-btn,
      .admin-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .search-btn:hover,
      .admin-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .results-section {
        margin-top: 25px;
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .results-header h3 {
        color: #333;
      }

      .results-count {
        color: #666;
        font-size: 14px;
      }

      .data-grid {
        display: grid;
        gap: 15px;
      }

      .data-card {
        background: white;
        border: 1px solid #e1e1e1;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .data-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .card-date {
        color: #666;
        font-size: 14px;
      }

      .rainfall-data {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      .rainfall-item {
        text-align: center;
        padding: 12px;
        background: #f8f9ff;
        border-radius: 8px;
        border: 1px solid #e1e8ff;
      }

      .rainfall-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .rainfall-value {
        font-size: 18px;
        font-weight: 600;
        color: #667eea;
      }

      .admin-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .edit-btn,
      .delete-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .edit-btn {
        background: #f39c12;
        color: white;
      }

      .delete-btn {
        background: #e74c3c;
        color: white;
      }

      .edit-btn:hover,
      .delete-btn:hover {
        transform: translateY(-1px);
      }

      .admin-form {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid #e1e1e1;
      }

      .admin-form h3 {
        margin-bottom: 20px;
        color: #333;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(400px);
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 300px;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.error {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .toast.success {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
      }

      .toast.warning {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .toast-close {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.8;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .search-form {
          grid-template-columns: 1fr !important;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .rainfall-data {
          grid-template-columns: repeat(2, 1fr);
        }

        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Rainfall Management System</h1>
      <div class="user-info">
        <span id="userEmail">user@example.com</span>
        <span id="userRole" class="user-badge">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="dashboard-container">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('search')">
          Search Rainfall Data
        </button>
        <button
          id="adminTab"
          class="tab"
          onclick="switchTab('admin')"
          style="display: none"
        >
          Admin Panel
        </button>
      </div>

      <!-- Search Tab -->
      <div id="searchTabContent" class="tab-content active">
        <div class="search-section">
          <h3 style="margin-bottom: 20px; color: #333">Search Options</h3>
          <div class="search-form">
            <div class="form-group">
              <label for="searchType">Search Type</label>
              <select id="searchType" onchange="updateSearchForm()">
                <option value="all">All Rainfall Data</option>
                <option value="day">Specific Day (All Locations)</option>
                <option value="location">Specific Location (All Days)</option>
                <option value="location-day">Specific Location & Day</option>
              </select>
            </div>
            <div class="form-group" id="locationGroup" style="display: none">
              <label for="location">Location</label>
              <input type="text" id="location" placeholder="e.g., Erean" />
            </div>
            <div class="form-group" id="dateGroup" style="display: none">
              <label for="searchDate">Date</label>
              <input type="date" id="searchDate" />
            </div>
          </div>
          <button
            class="search-btn"
            onclick="searchRainfall()"
            style="margin-top: 15px"
          >
            Search
          </button>
        </div>

        <div class="results-section">
          <div class="results-header">
            <h3>Search Results</h3>
            <span class="results-count" id="resultsCount">No data loaded</span>
          </div>
          <div id="searchResults">
            <div class="loading" style="display: none" id="loadingSpinner">
              <div class="spinner"></div>
              <p>Loading rainfall data...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Tab -->
      <div id="adminTabContent" class="tab-content">
        <div class="admin-form">
          <h3>Add New Rainfall Data</h3>
          <form id="addRainfallForm">
            <div class="form-row">
              <div class="form-group">
                <label for="addArea">Area/Location</label>
                <input type="text" id="addArea" required />
              </div>
              <div class="form-group">
                <label for="addDate">Date</label>
                <input type="date" id="addDate" required />
              </div>
              <div></div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="addAm1">AM1 (mm)</label>
                <input type="number" id="addAm1" step="0.1" required />
              </div>
              <div class="form-group">
                <label for="addAm2">AM2 (mm)</label>
                <input type="number" id="addAm2" step="0.1" required />
              </div>
              <div class="form-group">
                <label for="addPm1">PM1 (mm)</label>
                <input type="number" id="addPm1" step="0.1" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="addPm2">PM2 (mm)</label>
                <input type="number" id="addPm2" step="0.1" required />
              </div>
            </div>
            <div style="margin-top: 15px; text-align: center">
              <button type="submit" class="admin-btn">Add Rainfall Data</button>
            </div>
          </form>
        </div>

        <div class="results-section">
          <div class="results-header">
            <h3>All Rainfall Records</h3>
            <button class="admin-btn" onclick="loadAllRainfall()">
              Refresh Data
            </button>
          </div>
          <div id="adminResults">
            <div class="loading" style="display: none" id="adminLoadingSpinner">
              <div class="spinner"></div>
              <p>Loading all rainfall data...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let apiToken = null;

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        // Get user data from localStorage or redirect to login
        const userData = localStorage.getItem("userData");
        const token = localStorage.getItem("authToken");

        if (!userData || !token) {
          window.location.href = "login.html";
          return;
        }

        try {
          currentUser = JSON.parse(userData);
          apiToken = token;
          initializeDashboard();
        } catch (error) {
          console.error("Error parsing user data:", error);
          window.location.href = "login.html";
        }
      });

      function initializeDashboard() {
        // Update user info in header
        document.getElementById("userEmail").textContent =
          currentUser.email || "user@example.com";

        const roleElement = document.getElementById("userRole");
        if (currentUser.isAdmin || currentUser.role === "Admin") {
          roleElement.textContent = "Admin";
          roleElement.className = "admin-badge";
          document.getElementById("adminTab").style.display = "block";
        } else {
          roleElement.textContent = "User";
          roleElement.className = "user-badge";
        }

        // Load initial data
        loadAllRainfall();
      }

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById(tabName + "TabContent").classList.add("active");
      }

      function updateSearchForm() {
        const searchType = document.getElementById("searchType").value;
        const locationGroup = document.getElementById("locationGroup");
        const dateGroup = document.getElementById("dateGroup");

        // Hide all groups first
        locationGroup.style.display = "none";
        dateGroup.style.display = "none";

        if (searchType === "day" || searchType === "location-day") {
          dateGroup.style.display = "block";
        }
        if (searchType === "location" || searchType === "location-day") {
          locationGroup.style.display = "block";
        }
      }

      async function searchRainfall() {
        const searchType = document.getElementById("searchType").value;
        const location = document.getElementById("location").value.trim();
        const searchDate = document.getElementById("searchDate").value;

        let url = "http://localhost:3000/rainfall/";

        // Build URL based on search type
        switch (searchType) {
          case "all":
            url += "all";
            break;
          case "day":
            if (!searchDate) {
              showToast("Please select a date", "error");
              return;
            }
            url += `day/${searchDate}`;
            break;
          case "location":
            if (!location) {
              showToast("Please enter a location", "error");
              return;
            }
            url += `location/${encodeURIComponent(location)}`;
            break;
          case "location-day":
            if (!location || !searchDate) {
              showToast("Please enter both location and date", "error");
              return;
            }
            url += `location/${encodeURIComponent(location)}/day/${searchDate}`;
            break;
        }

        await fetchAndDisplayData(
          url,
          "searchResults",
          "loadingSpinner",
          false
        );
      }

      async function loadAllRainfall() {
        const isAdminView = document
          .getElementById("adminTab")
          .classList.contains("active");
        const resultsContainer = isAdminView ? "adminResults" : "searchResults";
        const loadingSpinner = isAdminView
          ? "adminLoadingSpinner"
          : "loadingSpinner";

        await fetchAndDisplayData(
          "http://localhost:3000/rainfall/all",
          resultsContainer,
          loadingSpinner,
          isAdminView
        );
      }

      async function fetchAndDisplayData(
        url,
        containerId,
        loadingId,
        isAdminView
      ) {
        const container = document.getElementById(containerId);
        const loading = document.getElementById(loadingId);

        // Show loading if element exists
        if (loading) {
          loading.style.display = "block";
        }
        container.innerHTML = "";

        try {
          const headers = {
            "Content-Type": "application/json",
          };

          // Add API key for authenticated requests
          if (apiToken) {
            headers["x-api-key"] = apiToken;
          }

          const response = await fetch(url, {
            method: "GET",
            headers: headers,
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Failed to fetch data");
          }

          displayRainfallData(data, container, isAdminView);

          // Update results count
          const count = Array.isArray(data) ? data.length : 1;
          const countElement = document.getElementById("resultsCount");
          if (countElement) {
            countElement.textContent = `${count} record(s) found`;
          }
        } catch (error) {
          console.error("Error fetching data:", error);

          // Show user-friendly error message
          let errorMessage = "An error occurred while fetching data";
          if (
            error.message.includes("No data found") ||
            error.message.includes("404")
          ) {
            errorMessage = "No rainfall data found for your search criteria";
          } else if (error.message.includes("fetch")) {
            errorMessage =
              "Unable to connect to server. Please check your connection.";
          } else {
            errorMessage = error.message;
          }

          container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                    <p>${errorMessage}</p>
                    <p style="margin-top: 10px; font-size: 14px;">Try adjusting your search criteria or contact support if the issue persists.</p>
                </div>`;

          // Update results count
          const countElement = document.getElementById("resultsCount");
          if (countElement) {
            countElement.textContent = "No records found";
          }

          showToast(errorMessage, "warning");
        } finally {
          // Hide loading if element exists
          if (loading) {
            loading.style.display = "none";
          }
        }
      }

      function displayRainfallData(data, container, isAdminView) {
        if (!data || (Array.isArray(data) && data.length === 0)) {
          container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;">🌧️</div>
                    <h3 style="margin-bottom: 10px;">No Rainfall Data Found</h3>
                    <p style="font-size: 14px;">No records match your search criteria. Try different search parameters.</p>
                </div>`;

          // Update results count
          const countElement = document.getElementById("resultsCount");
          if (countElement) {
            countElement.textContent = "No records found";
          }
          return;
        }

        const records = Array.isArray(data) ? data : [data];
        const dataGrid = document.createElement("div");
        dataGrid.className = "data-grid";

        records.forEach((record) => {
          const card = createRainfallCard(record, isAdminView);
          dataGrid.appendChild(card);
        });

        container.appendChild(dataGrid);
      }

      function createRainfallCard(record, isAdminView) {
        const card = document.createElement("div");
        card.className = "data-card";

        card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${record.area}</div>
                    <div class="card-date">${record.date}</div>
                </div>
                <div class="rainfall-data">
                    <div class="rainfall-item">
                        <div class="rainfall-label">AM1</div>
                        <div class="rainfall-value">${record.am1} mm</div>
                    </div>
                    <div class="rainfall-item">
                        <div class="rainfall-label">AM2</div>
                        <div class="rainfall-value">${record.am2} mm</div>
                    </div>
                    <div class="rainfall-item">
                        <div class="rainfall-label">PM1</div>
                        <div class="rainfall-value">${record.pm1} mm</div>
                    </div>
                    <div class="rainfall-item">
                        <div class="rainfall-label">PM2</div>
                        <div class="rainfall-value">${record.pm2} mm</div>
                    </div>
                </div>
                ${
                  isAdminView
                    ? `
                        <button class="delete-btn" onclick="deleteRecord('${record._id}')">Delete</button>
                    </div>
                `
                    : ""
                }
            `;

        return card;
      }

      // Admin functions
      document
        .getElementById("addRainfallForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            area: document.getElementById("addArea").value.trim(),
            date: formatDateForDB(document.getElementById("addDate").value),
            am1: parseFloat(document.getElementById("addAm1").value),
            am2: parseFloat(document.getElementById("addAm2").value),
            pm1: parseFloat(document.getElementById("addPm1").value),
            pm2: parseFloat(document.getElementById("addPm2").value),
          };

          try {
            const headers = {
              "Content-Type": "application/json",
            };

            // Add API key for admin operations
            if (apiToken) {
              headers["x-api-key"] = apiToken;
            }

            const response = await fetch("http://localhost:3000/rainfall/", {
              method: "POST",
              headers: headers,
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (response.ok) {
              showToast("Rainfall data added successfully!", "success");
              this.reset();
              loadAllRainfall();
            } else {
              throw new Error(data.message || "Failed to add rainfall data");
            }
          } catch (error) {
            console.error("Error adding rainfall data:", error);
            showToast(error.message, "error");
          }
        });

      async function deleteRecord(id) {
        if (!confirm("Are you sure you want to delete this record?")) {
          return;
        }

        try {
          const headers = {};

          // Add API key for admin operations
          if (apiToken) {
            headers["x-api-key"] = apiToken;
          }

          const response = await fetch(`http://localhost:3000/rainfall/${id}`, {
            method: "DELETE",
            headers: headers,
          });

          const data = await response.json();

          if (response.ok) {
            showToast("Record deleted successfully!", "success");
            loadAllRainfall();
          } else {
            throw new Error(data.message || "Failed to delete record");
          }
        } catch (error) {
          console.error("Error deleting record:", error);
          showToast(error.message, "error");
        }
      }

      // Utility functions
      function formatDateForDB(dateString) {
        // Convert YYYY-MM-DD to DD/MM/YYYY
        const [year, month, day] = dateString.split("-");
        return `${day}/${month}/${year}`;
      }

      function showToast(message, type = "error") {
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
                <button class="toast-close">&times;</button>
                ${message}
            `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        const autoHideTimer = setTimeout(() => {
          hideToast(toast);
        }, 5000);

        toast.querySelector(".toast-close").addEventListener("click", () => {
          clearTimeout(autoHideTimer);
          hideToast(toast);
        });
      }

      function hideToast(toast) {
        toast.classList.remove("show");
        setTimeout(() => {
          if (toast && toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }

      function logout() {
        localStorage.removeItem("userData");
        localStorage.removeItem("authToken");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
